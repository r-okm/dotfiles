#!/bin/bash
set -euo pipefail

COPILOT_MODEL="${COPILOT_MODEL:-{{ .copilot.model.sonnet }}}"

if git diff --cached --quiet; then
  echo "ステージされた変更がありません"
  exit 1
fi

DIFF_MAX=80000

PROMPT=$(cat <<'EOF'
Generate a commit message for the staged changes.
Output ONLY the commit message. No explanation, no code blocks.
Strictly follow the format of recent commit history in the repository.

## Rules:
- Subject: max 50 chars
- Blank line after subject
- Body: bulleted list with `-`, each line max 72 chars

## Recent commits
EOF
)
PROMPT+=$'\n'
PROMPT+=$(git log --format='---%n%s%+b' -10)
PROMPT+=$'\n\n## Changed files\n'
PROMPT+=$(git diff --cached --stat)
PROMPT+=$'\n\n## Diff\n'
PROMPT+=$(git diff --cached -- . ':!*lock*' ':!*.lock' | head -c "$DIFF_MAX")

# copilot doesn't read CLAUDE.md natively; inject it into the prompt
copilot_prompt=""
repo_root=$(git rev-parse --show-toplevel)
for f in ~/.claude/CLAUDE.md "$repo_root/CLAUDE.md" "$repo_root/CLAUDE.local.md"; do
  [ -f "$f" ] && copilot_prompt+="$(cat "$f")"$'\n\n'
done
copilot_prompt+="$PROMPT"

echo "copilot ($COPILOT_MODEL) でコミットメッセージを生成中..."
msg=$(copilot --prompt "$copilot_prompt" --silent --model "$COPILOT_MODEL" 2>/dev/null)

if [ -z "$msg" ]; then
  echo "コミットメッセージの生成に失敗しました"
  exit 1
fi

git commit --edit --message="$msg"
