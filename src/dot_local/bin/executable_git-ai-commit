#!/bin/bash
set -euo pipefail

CLAUDE_MODEL="${CLAUDE_MODEL:-sonnet}"
COPILOT_MODEL="${COPILOT_MODEL:-claude-sonnet-4.6}"

if git diff --cached --quiet; then
  echo "ステージされた変更がありません"
  exit 1
fi

# プロンプト構築
DIFF_MAX=80000

PROMPT=$(cat <<'PROMPT_EOF'
Generate a commit message for the staged changes.
Output ONLY the commit message. No explanation, no code blocks.
Follow the style of recent commits.

Format:
- Subject: max 50 chars, imperative mood
- Blank line after subject
- Body: bulleted list with `-`, each line max 72 chars

## Recent commits
PROMPT_EOF
)
PROMPT+=$'\n'
PROMPT+=$(git log --format='---%n%s%+b' -10)
PROMPT+=$'\n\n## Changed files\n'
PROMPT+=$(git diff --cached --stat)
PROMPT+=$'\n\n## Diff\n'
PROMPT+=$(git diff --cached | head -c "$DIFF_MAX")

MSG_FILE=$(mktemp --tmpdir git-ai-commit-msg.XXXXXX)
ERR_FILE=$(mktemp --tmpdir git-ai-commit-err.XXXXXX)
trap 'rm -f "$MSG_FILE" "$ERR_FILE"' EXIT

# claude で生成を試行
echo "claude ($CLAUDE_MODEL) でコミットメッセージを生成中..."
if claude -p "$PROMPT" --model "$CLAUDE_MODEL" > "$MSG_FILE" 2>"$ERR_FILE"; then
  echo "claude で生成完了"
else
  echo "claude が失敗したため copilot ($COPILOT_MODEL) にフォールバック..."
  copilot -p "$PROMPT" -s --model "$COPILOT_MODEL" > "$MSG_FILE" 2>/dev/null
fi

if [ ! -s "$MSG_FILE" ]; then
  echo "コミットメッセージの生成に失敗しました"
  exit 1
fi

git commit -e -F "$MSG_FILE"
