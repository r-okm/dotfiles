#!/bin/bash
set -euo pipefail

CLAUDE_MODEL="${CLAUDE_MODEL:-sonnet}"
COPILOT_MODEL="${COPILOT_MODEL:-claude-sonnet-4.5}"
PROMPT_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/prompts/COMMIT.md"

if git diff --cached --quiet; then
  echo "ステージされた変更がありません"
  exit 1
fi

# プロンプト構築
# git log: subject + body をセパレータ区切りで AI が解釈しやすい形式に
PROMPT="$(cat "$PROMPT_FILE")

## 過去のコミットメッセージ
$(git log --format='----------%n%s%n%n%b' -10)

## 変更内容
$(git diff --cached)

コミットメッセージのみを出力してください。説明やコードブロックは不要です。"

MSG_FILE=$(mktemp)
ERR_FILE=$(mktemp)
trap 'rm -f "$MSG_FILE" "$ERR_FILE"' EXIT

# claude で生成を試行
echo "claude ($CLAUDE_MODEL) でコミットメッセージを生成中..."
if claude -p "$PROMPT" --model "$CLAUDE_MODEL" > "$MSG_FILE" 2>"$ERR_FILE"; then
  echo "claude で生成完了"
else
  # rate limit / overload の場合のみ copilot にフォールバック
  # claude CLI は rate_limit_error (429) または overloaded_error (529) を stderr に出力
  if grep -qi "rate_limit_error\|overloaded_error\|too many request\|429\|529" "$ERR_FILE"; then
    echo "claude が rate limit のため copilot ($COPILOT_MODEL) にフォールバック..."
    copilot -p "$PROMPT" -s --model "$COPILOT_MODEL" > "$MSG_FILE" 2>/dev/null
  else
    echo "エラー: $(cat "$ERR_FILE")"
    exit 1
  fi
fi

if [ ! -s "$MSG_FILE" ]; then
  echo "コミットメッセージの生成に失敗しました"
  exit 1
fi

git commit -e -F "$MSG_FILE"
