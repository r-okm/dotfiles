# https://zenn.dev/kuro6061/articles/4880a8b7710746
# true color
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:RGB"

# https://qiita.com/hwatahik/items/e923b97e3caf734e16b3
# undercurl
set -ga terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -ga terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# in WSL
if-shell 'test -n "$WSL_DISTRO_NAME"' {
  set -ga terminal-overrides ',*:Setulc=\E[58::2::::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m' # underscore colours - needs tmux-3.0 (wsl2 in Windows Terminal)
}

# prefix key
set -g prefix C-g
unbind C-b

# custom key bindings
# C-<key> works same as <key>
bind C-c new-window
bind C-n next-window
bind C-p previous-window
bind C-s choose-tree -s
bind C-w choose-tree -w
bind C-[ copy-mode
bind C-] paste-buffer
# reload tmux config
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded!"
# open urlview to select URL from current pane
bind u capture-pane \; save-buffer /tmp/tmux-buffer \; split-window -l 10 'urlview < /tmp/tmux-buffer'
# open pane content in nvim readonly
bind v capture-pane \; save-buffer /tmp/tmux-buffer \; new-window 'nvim -R /tmp/tmux-buffer'
bind C-v capture-pane -S - \; save-buffer /tmp/tmux-buffer \; new-window 'nvim -R /tmp/tmux-buffer'
# edit prompt in editor and send to pane(for copilot cli)
bind i run-shell 'tmux set-environment TMUX_EDIT_PANE "#{pane_id}"' \; \
  split-window -v -l 15 -c "#{pane_current_path}" \
    'tmpfile=$(mktemp /tmp/tmux-edit-XXXXXX) && \
     nvim -u "$XDG_CONFIG_HOME/nvim/tmux_edit.lua" "$tmpfile" && \
     if [ -s "$tmpfile" ]; then \
       target=$(tmux show-environment TMUX_EDIT_PANE | cut -d= -f2) && \
       tmux load-buffer "$tmpfile" && tmux paste-buffer -t "$target" -r; \
     fi; \
     rm -f "$tmpfile"'
# select prompt with fzf and insert to pane(for copilot cli)
bind I run-shell 'tmux set-environment TMUX_PROMPT_PANE "#{pane_id}"' \; \
  display-popup -E -w 80% -h 60% \
    'prompts_dir="${XDG_CONFIG_HOME:-$HOME/.config}/prompts" && \
     selected=$(fd . "$prompts_dir" --type f --max-depth 1 | \
       xargs -n1 basename | \
       fzf --reverse --prompt="PROMPT > " --preview="cat $prompts_dir/{}") && \
     if [ -n "$selected" ]; then \
       target=$(tmux show-environment TMUX_PROMPT_PANE | cut -d= -f2) && \
       tmux load-buffer "$prompts_dir/$selected" && tmux paste-buffer -t "$target" -r; \
     fi'

# use vim key bindings in copy mode
setw -g mode-keys vi

# for neovim, remove delay when press escape key
set -g escape-time 0

# enable mouse support
set -g mouse on
set -ga terminal-overrides ',xterm*:smcup@:rmcup@'

# window index starts at 1
set -g base-index 1
# renumber windows after closing a window
set -g renumber-windows on

# show popup to switch to notification window
set-hook -g alert-bell {
  run-shell 'tmux set-environment TMUX_BELL_SESSION "#{session_name}"'
  run-shell 'tmux set-environment TMUX_BELL_WINDOW "#{window_index}"'
  if-shell '\
    bell_session=$(tmux show-environment TMUX_BELL_SESSION | cut -d= -f2); \
    bell_window=$(tmux show-environment TMUX_BELL_WINDOW | cut -d= -f2); \
    current=$(tmux display-message -p "##{session_name}:##{window_index}"); \
    [ "$bell_session:$bell_window" != "$current" ]' \
  {
    display-popup -E -w 30 -h 7 '\
      bell_session=$(tmux show-environment TMUX_BELL_SESSION | cut -d= -f2); \
      bell_window=$(tmux show-environment TMUX_BELL_WINDOW | cut -d= -f2); \
      display_session="$bell_session"; \
      if [ ${#display_session} -gt 10 ]; then \
        display_session="$(printf "%.9s~" "$bell_session")"; \
      fi; \
      echo ""; \
      printf "%*s\n" $(((29+24)/2)) "ðŸ”” Bell in $display_session:$bell_window"; \
      echo ""; \
      printf "%*s" $(((29+20)/2)) "Go to window? (y/n) "; \
      read answer; \
      if [ "$answer" = "y" ]; then \
        tmux switch-client -t "$bell_session:$bell_window"; \
      fi'
  }
}

# Configure the catppuccin plugin
set -g @catppuccin_flavor "frappe" # Options: latte, frappe, macchiato, mocha
set -g @catppuccin_status_left_separator "â–ˆ"
set -g @catppuccin_status_right_separator "â–ˆ"
set -g @catppuccin_status_connect_separator "yes"

# Load catppuccin
run ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux

# Make the status line pretty and add some modules
set -g status-right-length 100
set -g status-left-length 100
set -g status-left '#{?client_prefix,#[fg=cyan#,bg=#303030#,reverse] PREFIX #[default] ,}'
set -g status-right ""
set -ag status-right "#{E:@catppuccin_status_session}"

# Configure the extrakto plugin
set -g @extrakto_grab_area "window recent"
set -g @extrakto_filter_order "word line url all"
set -g @extrakto_key "y"
set -g @extrakto_copy_key "ctrl-y"
set -g @extrakto_insert_key "enter"
set -g @extrakto_clip_tool "clipboard --yank"
run-shell ~/.config/tmux/plugins/extrakto/extrakto.tmux
